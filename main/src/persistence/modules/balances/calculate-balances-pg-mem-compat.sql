DROP TABLE IF EXISTS BALANCE;

--
CREATE TABLE
  PUBLIC.BALANCE (ACCOUNT_ID UUID NOT NULL, TOTAL INTEGER NOT NULL);

--
INSERT INTO
  BALANCE
SELECT
  ACCOUNT.ACCOUNT_ID,
  ACCOUNT.INITIAL_AMOUNT AS TOTAL
FROM
  ACCOUNT
WHERE
  USER_ID = ${ userID }
ORDER BY
  ACCOUNT.NAME;

--
INSERT INTO
  BALANCE
SELECT
  TRANSFER.FROM_ACCOUNT_ID AS ACCOUNT_ID,
  SUM(AMOUNT) * -1 AS TOTAL
FROM
  TRANSFER
WHERE
  USER_ID = ${ userID }
GROUP BY
  TRANSFER.FROM_ACCOUNT_ID;

--
INSERT INTO
  BALANCE
SELECT
  TRANSFER.TO_ACCOUNT_ID AS ACCOUNT_ID,
  SUM(AMOUNT) AS TOTAL
FROM
  TRANSFER
WHERE
  USER_ID = ${ userID }
GROUP BY
  TRANSFER.TO_ACCOUNT_ID;

--
INSERT INTO
  BALANCE
SELECT
  OPERATION.ACCOUNT_ID,
  SUM(AMOUNT) AS TOTAL
FROM
  OPERATION
WHERE
  USER_ID = ${ userID }
GROUP BY
  OPERATION.ACCOUNT_ID;

--
SELECT
  BALANCE.ACCOUNT_ID,
  CAST(SUM(BALANCE.TOTAL) AS INTEGER) AS TOTAL
FROM
  BALANCE
GROUP BY
  BALANCE.ACCOUNT_ID;
